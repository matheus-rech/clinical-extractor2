# =============================================================================
# Render.com Blueprint Configuration for Clinical Extractor
# =============================================================================
# Deploy: Connect GitHub repo to Render.com and it auto-detects this file
# Add GEMINI_API_KEY via Render dashboard (Environment Variables)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend Service (Python FastAPI)
  # ---------------------------------------------------------------------------
  - type: web
    name: clinical-extractor-backend
    runtime: python
    region: oregon  # or: ohio, frankfurt, singapore
    plan: free  # Free tier
    branch: master
    rootDir: backend
    buildCommand: poetry install --no-interaction --no-ansi
    startCommand: poetry run uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 4
    healthCheckPath: /health
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: GEMINI_API_KEY
        sync: false  # Add via Render dashboard (Secret)
      - key: CORS_ORIGINS
        value: https://clinical-extractor-frontend.onrender.com
      - key: LOG_LEVEL
        value: info
      - key: WORKERS
        value: "4"

  # ---------------------------------------------------------------------------
  # Frontend Service (Static Site with Nginx)
  # ---------------------------------------------------------------------------
  - type: web
    name: clinical-extractor-frontend
    runtime: static
    region: oregon
    plan: free
    branch: master
    buildCommand: npm ci && npm run build
    staticPublishPath: ./dist
    pullRequestPreviewsEnabled: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: "1; mode=block"
    routes:
      - type: rewrite
        source: /*
        destination: /index.html  # SPA routing
    envVars:
      - key: NODE_ENV
        value: production
      - key: VITE_BACKEND_URL
        value: https://clinical-extractor-backend.onrender.com

# =============================================================================
# Optional: PostgreSQL Database (90-day free trial)
# =============================================================================
# databases:
#   - name: clinical-extractor-db
#     databaseName: clinical_extractor
#     plan: free
#     region: oregon
#     user: clinical_user

# =============================================================================
# Optional: Redis Cache
# =============================================================================
# - type: redis
#   name: clinical-extractor-redis
#   plan: free
#   region: oregon
#   maxmemoryPolicy: allkeys-lru
